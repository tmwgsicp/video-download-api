# 故障排除

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [UPGRADE_INSTRUCTIONS.md](file://UPGRADE_INSTRUCTIONS.md)
- [COOKIES_GUIDE.md](file://cookies/COOKIES_GUIDE.md)
- [video_processor.py](file://api/video_processor.py)
- [main.py](file://api/main.py)
- [cookies_manager.py](file://api/cookies_manager.py)
- [file_cleaner.py](file://api/file_cleaner.py)
- [start.py](file://start.py)
</cite>

## 目录
1. [平台访问失败](#平台访问失败)
2. [视频下载失败](#视频下载失败)
3. [音频提取失败](#音频提取失败)
4. [服务启动失败](#服务启动失败)
5. [任务卡在处理中](#任务卡在处理中)
6. [版本升级注意事项](#版本升级注意事项)
7. [日志分析技巧](#日志分析技巧)

## 平台访问失败

当尝试访问需要身份验证的平台（如抖音、B站）时，可能会出现访问失败的情况。这通常是由于Cookies过期或配置不正确导致的。

### 解决方案

1. **检查Cookies文件是否存在**
   - 确保在 `cookies/` 目录下存在对应平台的Cookies文件
   - 抖音平台必需文件：`douyin.txt`
   - B站可选文件：`bilibili.txt`
   - 小红书可选文件：`xiaohongshu.txt`

2. **更新Cookies**
   - 参考 [COOKIES_GUIDE.md](file://cookies/COOKIES_GUIDE.md) 获取最新的Cookies
   - 登录目标网站后，通过浏览器开发者工具复制完整的Cookie字符串
   - 将复制的Cookie粘贴到对应的文件中并保存

3. **验证Cookies有效性**
   - 访问 `/api/cookies/status` 接口查看Cookies状态
   - 系统会自动检测并提醒过期的Cookies
   - 可通过 `POST /api/cookies/check` 手动触发检查

4. **正确格式化Cookies**
   - 支持完整Cookie字符串格式
   - 支持一行一个Cookie的格式
   - 系统会自动转换为yt-dlp兼容的Netscape格式

**重要提示**：抖音平台强制需要有效的Cookies才能访问内容，其他平台的Cookies用于访问会员或受限内容。

**Section sources**
- [COOKIES_GUIDE.md](file://cookies/COOKIES_GUIDE.md)
- [cookies_manager.py](file://api/cookies_manager.py#L129-L334)

## 视频下载失败

视频下载失败通常由URL无效、网络问题或yt-dlp解析错误引起。

### 常见原因及解决方案

1. **检查URL有效性**
   - 确认提供的视频链接是有效的
   - 对于抖音短链接，系统会自动解析重定向，但仍需确保原始链接正确
   - 使用 `GET /api/process` 前先手动访问链接确认可播放

2. **验证平台支持**
   - 确认目标平台在yt-dlp支持列表中
   - 支持YouTube、Bilibili、TikTok等30+平台
   - 查看 [yt-dlp支持列表](https://github.com/yt-dlp/yt-dlp/blob/master/supportedsites.md)

3. **检查网络连接**
   - 确保服务器网络畅通
   - 某些平台可能需要特定地区的网络访问
   - 尝试更换网络环境或使用VPN

4. **查看详细错误日志**
   - 检查API日志中的具体错误信息
   - 日志会记录yt-dlp的详细错误原因
   - 根据错误信息采取相应措施

5. **重试机制**
   - 系统在视频下载失败时会自动重试一次
   - 如果重试仍失败，会尝试应急方案
   - 可手动重新提交任务

**Section sources**
- [video_processor.py](file://api/video_processor.py#L345-L370)
- [main.py](file://api/main.py#L200-L250)

## 音频提取失败

音频提取失败可能由FFmpeg未安装、版本不兼容或yt-dlp解析问题导致。

### 解决方案

1. **检查FFmpeg安装**
   - 确认FFmpeg已正确安装
   - 在命令行运行 `ffmpeg -version` 验证
   - 如未安装，根据系统选择安装方式：
     - macOS: `brew install ffmpeg`
     - Ubuntu: `sudo apt install ffmpeg`
     - Windows: 从官网下载安装

2. **智能回退机制**
   - 系统采用双重音频提取策略：
     - 优先使用yt-dlp直接提取音频流（速度快）
     - 失败时自动下载视频后用FFmpeg提取音频
   - 这种机制确保在各种情况下都能成功提取音频

3. **检查音频提取配置**
   - 验证音频格式选择策略
   - 检查比特率和采样率设置
   - 确认输出格式支持

4. **处理临时文件**
   - 当仅需音频时，系统会自动删除临时视频文件
   - 如果删除失败，会在日志中记录警告
   - 可手动清理temp目录

5. **验证FFmpeg兼容性**
   - 某些视频格式可能需要特定的FFmpeg编解码器
   - 确保FFmpeg版本较新，支持现代音频格式
   - 检查是否支持MP3、AAC等常用格式

**Section sources**
- [video_processor.py](file://api/video_processor.py#L372-L427)
- [start.py](file://start.py#L20-L40)

## 服务启动失败

服务启动失败可能由端口占用、依赖缺失或环境配置问题引起。

### 常见问题及解决方法

1. **检查Python版本**
   - 必须使用Python 3.8+版本
   - 推荐使用Python 3.10-3.12
   - 检查版本：`python3 --version`
   - 如版本过低，参考 [UPGRADE_INSTRUCTIONS.md](file://UPGRADE_INSTRUCTIONS.md) 升级

2. **验证依赖安装**
   - 确保所有Python依赖已安装
   - 运行 `pip install -r requirements.txt`
   - 检查以下关键包：
     - fastapi
     - uvicorn
     - yt-dlp
     - pydantic
     - aiofiles

3. **检查端口占用**
   - 默认使用8000端口
   - 检查端口是否被其他进程占用
   - 查看端口占用：`lsof -i :8000` (macOS/Linux) 或 `netstat -ano | findstr :8000` (Windows)
   - 修改端口：编辑 `install.sh` 或 `deploy.sh` 中的端口号

4. **验证FFmpeg安装**
   - 音频提取必需FFmpeg
   - 检查安装：`ffmpeg -version`
   - 如未安装，按系统要求安装

5. **检查磁盘空间**
   - 确保有足够的磁盘空间存储临时文件
   - 临时文件存储在 `temp/` 目录
   - 定期清理可避免空间不足

6. **权限问题**
   - 确保有读写权限
   - 特别是 `temp/` 目录和 `cookies/` 目录
   - 设置正确文件权限

**Section sources**
- [start.py](file://start.py)
- [requirements.txt](file://requirements.txt)
- [UPGRADE_INSTRUCTIONS.md](file://UPGRADE_INSTRUCTIONS.md)

## 任务卡在处理中

任务卡在"处理中"状态可能是由于后台进程异常、网络超时或资源不足导致。

### 解决方案

1. **检查任务状态**
   - 通过 `GET /api/status/{task_id}` 查询任务详细状态
   - 查看进度百分比和当前处理阶段
   - 检查是否有错误信息

2. **查看系统日志**
   - 分析API日志中的处理流程
   - 查找可能的错误或警告信息
   - 关注yt-dlp和FFmpeg的执行情况

3. **检查资源使用**
   - 查看CPU和内存使用情况
   - 确保有足够的系统资源
   - 长视频处理需要更多资源

4. **网络超时处理**
   - 系统设置了合理的超时限制
   - 如果网络不稳定，可能会导致超时
   - 可适当增加超时时间

5. **重启服务**
   - 如果多个任务卡住，考虑重启服务
   - 重启会清除所有进行中的任务
   - 使用 `Ctrl+C` 停止后重新启动

6. **取消卡住的任务**
   - 使用 `DELETE /api/tasks/{task_id}` 取消任务
   - 这会释放相关资源
   - 可重新提交任务

7. **检查文件清理服务**
   - 确认文件清理服务正常运行
   - 查看 `temp/` 目录文件数量和大小
   - 手动清理：`POST /api/storage/cleanup`

**Section sources**
- [main.py](file://api/main.py#L400-L500)
- [file_cleaner.py](file://api/file_cleaner.py#L69-L170)

## 版本升级注意事项

版本升级时需要注意Python版本兼容性和依赖更新。

### 升级指南

1. **使用一键升级脚本**
   - 运行 `chmod +x upgrade_python.sh`
   - 执行 `./upgrade_python.sh`
   - 脚本会自动检测系统类型和当前Python版本

2. **选择合适的Python版本**
   - **选项1**: Python 3.8 - 最低要求版本，最大兼容性
   - **选项2**: Python 3.9 - 稳定版本，生产环境推荐
   - **选项3**: Python 3.10 - 推荐版本，性能与稳定性平衡
   - **选项4**: Python 3.11 - 推荐版本，更好的性能
   - **选项5**: Python 3.12 - 最新版本，追求最新特性
   - **选项6**: 自定义版本 - 输入任意3.x.y格式的版本号

3. **升级后验证**
   - 检查Python版本：`python3 --version`
   - 验证pip正常工作
   - 确认venv模块可用
   - 验证SSL模块正常（网络功能必需）

4. **重新安装依赖**
   - 升级Python后，需要重新安装依赖
   - 运行 `pip install -r requirements.txt`
   - 或使用部署脚本自动安装

5. **常见问题处理**
   - **升级失败**:
     - 检查错误信息和解决建议
     - 可多次运行脚本，会自动清理失败的安装
     - 查看 `/tmp/python-build.*.log` 获取详细错误信息
   - **CentOS 7特殊问题**:
     - SSL编译错误：脚本已自动配置SSL环境变量
     - 下载速度慢：脚本已配置国内镜像源
     - 如仍然失败：尝试安装较低版本如Python 3.10
   - **部署脚本检测到旧版本**:
     - 检查 `which python3` 和 `python3 --version`
     - 手动设置软链接：`sudo update-alternatives --config python3` (Ubuntu/Debian)

6. **升级成功标志**
   - `python3 --version` 显示目标版本
   - `./deploy.sh` 能正常执行
   - 服务启动无版本相关错误

**Section sources**
- [UPGRADE_INSTRUCTIONS.md](file://UPGRADE_INSTRUCTIONS.md)
- [start.py](file://start.py)

## 日志分析技巧

有效的日志分析能帮助快速定位和解决问题。

### 日志分析方法

1. **理解日志级别**
   - **INFO**: 一般信息，处理流程
   - **WARNING**: 警告信息，可能影响功能
   - **ERROR**: 错误信息，功能失败
   - **DEBUG**: 详细调试信息（如启用）

2. **关键日志点分析**
   - **服务启动日志**:
     - 检查依赖和FFmpeg是否正常
     - 确认临时目录创建成功
     - 查看服务器启动信息
   - **Cookies检查日志**:
     - 查看各平台Cookies状态
     - 注意过期提醒和缺失警告
     - 关注自动转换和加载信息
   - **视频处理日志**:
     - 跟踪处理流程各阶段
     - 查看URL解析和平台识别
     - 监控下载和提取进度
   - **文件清理日志**:
     - 了解清理策略执行情况
     - 查看删除的文件和释放的空间
     - 监控存储使用情况

3. **常见错误模式识别**
   - **Cookies相关错误**:
     - "缺少必需的cookies文件"
     - "cookies文件可能过期"
     - "cookies无效或过期"
   - **下载相关错误**:
     - "下载视频失败"
     - "提取音频失败"
     - "无法确定cookies状态"
   - **系统相关错误**:
     - "缺少依赖包"
     - "未找到FFmpeg"
     - "端口被占用"

4. **使用API接口辅助分析**
   - `GET /api/cookies/status`: 查看Cookies状态
   - `GET /api/storage/info`: 获取存储空间信息
   - `GET /api/tasks`: 列出所有任务状态
   - `GET /api/status/{task_id}`: 查询特定任务详情

5. **日志文件管理**
   - 主要日志输出到控制台
   - Cookies通知可记录到文件
   - 可配置Webhook通知到企微机器人
   - 定期归档重要日志

6. **分析工具建议**
   - 使用 `grep` 过滤特定关键词
   - 按时间顺序分析处理流程
   - 关注错误前后的上下文
   - 对比成功和失败案例的日志差异

**Section sources**
- [main.py](file://api/main.py)
- [video_processor.py](file://api/video_processor.py)
- [cookies_manager.py](file://api/cookies_manager.py)
- [file_cleaner.py](file://api/file_cleaner.py)