# 核心功能

<cite>
**本文档引用的文件**  
- [video_processor.py](file://api/video_processor.py)
- [cookies_manager.py](file://api/cookies_manager.py)
- [file_cleaner.py](file://api/file_cleaner.py)
- [config.yaml](file://cookies/config.yaml)
</cite>

## 目录
1. [视频处理功能](#视频处理功能)  
2. [Cookies管理功能](#cookies管理功能)  
3. [文件清理功能](#文件清理功能)

## 视频处理功能

`video_processor.py` 模块是 `video-download-api` 的核心组件之一，负责实现多平台视频下载与智能格式选择。该模块基于 `yt-dlp` 库构建，支持从抖音、B站、小红书、YouTube、TikTok 等主流平台下载视频和提取音频。

### URL解析与平台识别

在下载视频前，系统首先通过 `_get_platform_from_url` 方法解析传入的URL，识别其所属平台。该方法通过检查URL中包含的域名关键词（如 `douyin.com`、`bilibili.com`）来判断平台类型。对于抖音的短链接（`v.douyin.com`），系统会调用 `_resolve_douyin_url` 方法，使用 `requests` 库发起HTTP请求并跟踪重定向，获取真实的视频URL，确保后续下载流程的准确性。

### 基于yt-dlp的下载与格式选择

`VideoProcessor` 类在初始化时会构建基础的 `yt-dlp` 配置 `base_opts`，并根据是否提供 `cookies_file` 参数决定是否启用登录状态。系统定义了 `video_opts` 和 `audio_opts` 两个核心配置字典，分别用于视频下载和音频提取。

- **视频下载策略**：`video_opts` 中的 `format` 字段定义了多层回退的智能格式选择策略。系统优先尝试下载720p以下、文件大小小于100MB的合并格式；若失败，则尝试合并视频和音频流；再失败则回退到单独的视频格式，最终兜底到最差质量的格式，确保下载成功率。
- **音频提取策略**：`audio_opts` 优先选择文件大小合理的最佳音频流，若无纯音频流，则尝试从最佳视频格式中提取。

### 重试机制与格式回退策略

`download_video_and_audio` 方法是核心的下载入口，支持同时下载视频和提取音频，或单独执行其中一项。该方法实现了复杂的重试和回退机制：

- **并行下载**：当同时需要视频和音频时，系统会启动两个异步任务并行下载，提高效率。
- **双向回退**：
  - 若音频下载失败但视频成功，系统会调用 `_extract_audio_from_video` 方法，使用 `FFmpeg` 从已下载的视频文件中提取音频。
  - 若视频下载失败但音频成功，系统会尝试重新下载视频一次。
  - 若两者均失败，系统会尝试下载一个“应急”视频，再从中提取音频。
- **异常处理**：整个下载流程被包裹在 `try-except` 块中，任何阶段的失败都会被捕获并记录日志，最后向上抛出带有详细信息的异常。

该功能在整体架构中扮演着“执行引擎”的角色，直接与外部平台交互，获取原始媒体数据，为上层API提供基础服务。

**Section sources**
- [video_processor.py](file://api/video_processor.py#L13-L82)
- [video_processor.py](file://api/video_processor.py#L84-L97)
- [video_processor.py](file://api/video_processor.py#L99-L127)
- [video_processor.py](file://api/video_processor.py#L129-L152)
- [video_processor.py](file://api/video_processor.py#L178-L190)
- [video_processor.py](file://api/video_processor.py#L192-L343)

## Cookies管理功能

`cookies_manager.py` 模块负责管理、验证和维护用于访问需登录平台的Cookies文件，确保API能够持续访问受保护的内容。

### 加载与配置

`CookiesManager` 类在初始化时加载 `cookies/config.yaml` 配置文件。该配置文件定义了支持的平台（如抖音、B站、小红书），每个平台的名称、对应的Cookies文件名、是否必需、检查间隔和过期提醒天数。如果配置文件不存在，系统会使用内置的默认配置。

### Cookies文件加载与有效性验证

`get_cookies_file_for_url` 方法是获取Cookies文件的入口。它根据URL识别平台，查找配置中指定的Cookies文件。如果文件不存在且该平台为“必需”，则记录错误日志并通知用户。

系统通过 `check_cookies_validity` 方法检查Cookies的有效性：
1.  **存在性检查**：确认文件是否存在。
2.  **时效性检查**：检查文件的修改时间，若超过7天则认为可能已过期。
3.  **功能性验证**：调用 `_test_cookies_with_ytdlp` 方法，使用 `yt-dlp` 尝试访问平台主页（如B站首页）来验证Cookies是否有效。对于反爬机制严格的抖音，系统会跳过在线验证，仅检查文件存在性。

### 支持多种Cookies格式

系统支持两种Cookies格式：
1.  **Netscape格式**：标准的文本文件格式。
2.  **浏览器Cookies字符串**：用户从浏览器开发者工具中直接复制的 `name=value;` 格式的字符串。

`_process_cookies_file` 方法能自动识别这两种格式。对于字符串格式，它会调用 `_parse_cookies_string` 进行解析，然后生成一个临时的Netscape格式文件供 `yt-dlp` 使用，极大地提升了用户配置的便利性。

### 异常处理与通知机制

当检测到Cookies问题（如缺失或过期）时，系统会通过 `_notify_cookies_issue` 和 `_notify_missing_cookies` 方法触发通知。通知方式可配置，包括：
- **日志记录**：在日志中输出警告或错误信息。
- **文件记录**：将通知写入指定的日志文件。
- **Webhook通知**：向企业微信机器人发送消息，实现即时告警。

该功能在架构中充当“身份代理”，为视频下载模块提供必要的认证信息，是访问受登录保护内容的关键桥梁。

**Section sources**
- [cookies_manager.py](file://api/cookies_manager.py#L22-L33)
- [cookies_manager.py](file://api/cookies_manager.py#L35-L46)
- [cookies_manager.py](file://api/cookies_manager.py#L82-L95)
- [cookies_manager.py](file://api/cookies_manager.py#L97-L127)
- [cookies_manager.py](file://api/cookies_manager.py#L129-L167)
- [cookies_manager.py](file://api/cookies_manager.py#L169-L220)
- [cookies_manager.py](file://api/cookies_manager.py#L222-L232)
- [cookies_manager.py](file://api/cookies_manager.py#L234-L274)
- [cookies_manager.py](file://api/cookies_manager.py#L276-L334)
- [config.yaml](file://cookies/config.yaml#L1-L47)

## 文件清理功能

`file_cleaner.py` 模块负责定期清理过期的下载文件，防止临时文件无限增长导致磁盘空间耗尽。

### 清理策略

`FileCleanerManager` 类实现了多维度的清理策略，由 `_execute_cleanup_strategy` 方法执行：
1.  **保留最近文件**：无论其他条件如何，都会保留最近创建的 `preserve_recent_files` 个文件（默认10个），防止正在使用的文件被误删。
2.  **按时间清理**：删除超过 `file_retention_hours` 小时（默认24小时）的文件。
3.  **按存储空间清理**：当所有文件的总大小超过 `max_storage_mb` MB（默认1000MB）时，系统会按修改时间排序，从最旧的文件开始删除，直到总大小低于阈值。

### 定时任务与异常处理

`start_cleanup_service` 方法启动一个后台协程，实现定时清理：
- **启动时清理**：服务启动时立即执行一次清理。
- **定期清理**：根据 `check_interval` 配置（默认3600秒，即1小时）循环执行清理任务。
- **异常处理**：清理过程中捕获所有异常，记录错误日志，并等待60秒后重试，保证服务的稳定性。

`cleanup_files` 方法是清理的入口，它首先调用 `_get_files_info` 收集临时目录下所有文件的信息（路径、大小、修改时间等），然后交给 `_execute_cleanup_strategy` 执行具体的清理逻辑。`_delete_file` 方法负责安全地删除文件，并记录操作日志。

该功能在架构中扮演“系统维护者”的角色，保障了服务的长期稳定运行，避免了因磁盘空间不足导致的服务中断。

**Section sources**
- [file_cleaner.py](file://api/file_cleaner.py#L18-L28)
- [file_cleaner.py](file://api/file_cleaner.py#L30-L39)
- [file_cleaner.py](file://api/file_cleaner.py#L41-L62)
- [file_cleaner.py](file://api/file_cleaner.py#L69-L96)
- [file_cleaner.py](file://api/file_cleaner.py#L98-L116)
- [file_cleaner.py](file://api/file_cleaner.py#L118-L170)
- [file_cleaner.py](file://api/file_cleaner.py#L172-L181)